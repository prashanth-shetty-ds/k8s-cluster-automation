name: Kubernetes Bootstrap

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Select the operation to perform"
        required: true
        default: "bootstrap-cluster"
        type: choice
        options:
          - bootstrap-cluster
          - join-workers
          - deploy-observability

jobs:
  install-k8s:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load inventory
        run: |
          set -a
          source inventory/hosts.env
          set +a

      - name: Install Kubernetes prerequisites (ALL nodes)
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        run: |
          for node in $MASTER_IP $WORKER_0_IP $WORKER_1_IP; do
            echo "Installing prerequisites on $node"
            ssh $SSH_USER@$node 'sudo bash -s' < scripts/common.sh
          done

      - name: Bootstrap Kubernetes Master
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        run: |
          ssh $SSH_USER@$MASTER_IP 'sudo bash -s' < scripts/master.sh

      - name: Join Worker Nodes
        if: |
          github.event.inputs.action == 'bootstrap-cluster' ||
          github.event.inputs.action == 'join-workers'
        run: |
          ssh $SSH_USER@$WORKER_0_IP 'sudo bash -s' < scripts/worker.sh
          ssh $SSH_USER@$WORKER_1_IP 'sudo bash -s' < scripts/worker.sh

      - name: Deploy Observability Stack
        if: ${{ github.event.inputs.action == 'deploy-observability' }}
        run: |
          ssh $SSH_USER@$MASTER_IP <<EOF
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f manifests/monitoring/
          EOF
