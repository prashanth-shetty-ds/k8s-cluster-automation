name: Kubernetes Bootstrap

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Select the operation to perform"
        required: true
        default: "bootstrap-cluster"
        type: choice
        options:
          - bootstrap-cluster
          - join-workers
          - deploy-observability

jobs:
  install-k8s:
    runs-on: [self-hosted]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ”§ FIX 1: Export inventory variables to GITHUB_ENV
      - name: Load inventory
        shell: bash
        run: |
          set -a
          source inventory/hosts.env
          set +a

          echo "MASTER_IP=$MASTER_IP" >> $GITHUB_ENV
          echo "WORKER_0_IP=$WORKER_0_IP" >> $GITHUB_ENV
          echo "WORKER_1_IP=$WORKER_1_IP" >> $GITHUB_ENV
          echo "SSH_USER=$SSH_USER" >> $GITHUB_ENV

      # ðŸ”§ FIX 2: CI-safe SSH + sudo (TTY + non-interactive)
      - name: Install Kubernetes prerequisites (ALL nodes)
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        shell: bash
        run: |
          for node in $MASTER_IP $WORKER_0_IP $WORKER_1_IP; do
            echo "Installing prerequisites on $node"
            ssh -tt \
                -o BatchMode=yes \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                $SSH_USER@$node \
                'sudo -n -i bash -s' < scripts/common.sh
          done

      - name: Bootstrap Kubernetes Master
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        shell: bash
        run: |
          ssh -tt \
              -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              $SSH_USER@$MASTER_IP \
              'sudo -n -i bash -s' < scripts/master.sh
 
      - name: Validate Kubernetes Control Plane
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        shell: bash
        run: |
          ssh -tt \
              -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              $SSH_USER@$MASTER_IP \
              'test -f /etc/kubernetes/admin.conf'

          echo "[SUCCESS] kubeadm init verified"


      - name: Join Worker Nodes
        if: |
          github.event.inputs.action == 'bootstrap-cluster'
        shell: bash
        run: |
          echo "[INFO] Joining workers only after master validation"
          for node in $WORKER_0_IP $WORKER_1_IP; do
            ssh -tt \
                -o BatchMode=yes \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                $SSH_USER@$node \
                'sudo -n -i bash -s' < scripts/worker.sh
          done


      - name: Deploy Observability Stack
        if: ${{ github.event.inputs.action == 'deploy-observability' }}
        shell: bash
        run: |
          ssh -tt \
              -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              $SSH_USER@$MASTER_IP <<EOF
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f manifests/monitoring/
          EOF
