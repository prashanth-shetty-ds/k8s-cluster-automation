name: Kubernetes Bootstrap

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Operation"
        required: true
        default: "bootstrap-cluster"
        type: choice
        options:
          - bootstrap-cluster
          - join-workers

jobs:
  bootstrap:
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load inventory
        shell: bash
        run: |
          set -a
          source inventory/hosts.env
          set +a
          echo "MASTER_IP=$MASTER_IP" >> $GITHUB_ENV
          echo "WORKER_0_IP=$WORKER_0_IP" >> $GITHUB_ENV
          echo "WORKER_1_IP=$WORKER_1_IP" >> $GITHUB_ENV
          echo "SSH_USER=$SSH_USER" >> $GITHUB_ENV

      - name: Install prerequisites (ALL nodes)
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        run: |
          for node in $MASTER_IP $WORKER_0_IP $WORKER_1_IP; do
            echo "[INFO] Common setup on $node"
            ssh -o BatchMode=yes \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                $SSH_USER@$node \
                'sudo bash -s' < scripts/common.sh
          done

      - name: Bootstrap Master
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        run: |
          ssh -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              $SSH_USER@$MASTER_IP \
              'sudo bash -s' < scripts/master.sh

      - name: Validate Master
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        run: |
          ssh -o BatchMode=yes \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              $SSH_USER@$MASTER_IP \
              'test -f /etc/kubernetes/admin.conf'

      - name: Fetch join command from master
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        shell: bash
        run: |
          ssh -o BatchMode=yes \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$MASTER_IP \
            'sudo cat /etc/kubernetes/join-command.sh' > /tmp/kubeadm_join.sh
            chmod +x /tmp/kubeadm_join.sh

      - name: Join Workers
        if: |
          github.event.inputs.action == 'bootstrap-cluster' ||
          github.event.inputs.action == 'join-workers'
        shell: bash
        run: |
          set -euxo pipefail
          for node in "$WORKER_0_IP" "$WORKER_1_IP"; do
            echo "[INFO] Joining worker $node"
            scp -o BatchMode=yes \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                /tmp/kubeadm_join.sh \
                $SSH_USER@$node:/tmp/kubeadm_join.sh
            ssh -o BatchMode=yes \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                $SSH_USER@$node \
                'sudo bash /tmp/kubeadm_join.sh'
          done

