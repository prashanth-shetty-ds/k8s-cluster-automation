name: Kubernetes Bootstrap

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Operation"
        required: true
        default: "bootstrap-cluster"
        type: choice
        options:
          - bootstrap-cluster
          - join-workers

jobs:
  bootstrap:
    runs-on: [self-hosted, linux]

    steps:
      - uses: actions/checkout@v4

      - name: Identify node role
        shell: bash
        run: |
          HOST=$(hostname)
          if [[ "$HOST" == "master-0" ]]; then
            echo "NODE_ROLE=MASTER" >> $GITHUB_ENV
          elif [[ "$HOST" == worker-* ]]; then
            echo "NODE_ROLE=WORKER" >> $GITHUB_ENV
          else
            echo "Unknown node role"; exit 1
          fi
          echo "Running on $HOST"

      - name: Install Kubernetes prerequisites
        if: ${{ github.event.inputs.action == 'bootstrap-cluster' }}
        shell: bash
        run: |
          sudo bash scripts/common.sh

      - name: Bootstrap Kubernetes Master
        if: |
          github.event.inputs.action == 'bootstrap-cluster' &&
          env.NODE_ROLE == 'MASTER'
        shell: bash
        run: |
          sudo bash scripts/master.sh

      - name: Join Worker to Cluster
        if: |
          github.event.inputs.action == 'bootstrap-cluster' &&
          env.NODE_ROLE == 'WORKER'
        shell: bash
        run: |
          sudo bash scripts/worker.sh
